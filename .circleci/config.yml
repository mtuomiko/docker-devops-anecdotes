version: 2.1
jobs:
  build-push-deploy:
    machine: true
    steps:
      - checkout
      - run: docker build -t $DOCKER_LOGIN/$CIRCLE_PROJECT_REPONAME .
      - run: |
          docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD
          docker push $DOCKER_LOGIN/$CIRCLE_PROJECT_REPONAME
      - run: |
          docker login --username=$HEROKU_LOGIN --password=$HEROKU_API_KEY registry.heroku.com
          docker tag $DOCKER_LOGIN/$CIRCLE_PROJECT_REPONAME registry.heroku.com/$HEROKU_APP_NAME/web
          docker push registry.heroku.com/$HEROKU_APP_NAME/web

