version: 2.1
jobs:
  build:
    machine: true
    steps:
      - checkout
      - run:
          name: Install Heroku CLI (If not installed)
          command: |
            if [[ $(command -v heroku) == "" ]]; then
              curl https://cli-assets.heroku.com/install.sh | sh
            else
              echo "Heroku is already installed. No operation was performed."
            fi
      - run: 
          name: Build Docker image
          command: docker build -t $DOCKER_LOGIN/$CIRCLE_PROJECT_REPONAME .
      - run:
          name: Login to Docker Hub and push image. 
          command: |
            docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD
            docker push $DOCKER_LOGIN/$CIRCLE_PROJECT_REPONAME
      - run:
          name: Login to Heroku registry, push new image and release. 
          command: |
            docker login --username=$HEROKU_LOGIN --password=$HEROKU_API_KEY registry.heroku.com
            docker tag $DOCKER_LOGIN/$CIRCLE_PROJECT_REPONAME registry.heroku.com/$HEROKU_APP_NAME/web
            docker push registry.heroku.com/$HEROKU_APP_NAME/web
            heroku container:login
            heroku container:release -a $HEROKU_APP_NAME web

